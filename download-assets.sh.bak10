#!/bin/zsh
# Script pour t√©l√©charger les assets n√©cessaires pour le mode offline
# Compatible avec zsh et bash

echo "üì• T√©l√©chargement des assets pour le mode offline..."

# Cr√©er tous les dossiers n√©cessaires
echo "üìÅ Cr√©ation de la structure de dossiers..."
mkdir -p static/js static/css static/webfonts static/fonts static/js/monaco-editor/vs static/js/prism static/icons
echo "   ‚úÖ Dossiers cr√©√©s"

# T√©l√©charger Tailwind CSS Play CDN (standalone)
echo "üì¶ T√©l√©chargement de Tailwind CSS..."
curl -L https://cdn.tailwindcss.com -o static/js/tailwindcss.js || {
    echo "‚ö†Ô∏è  √âchec du t√©l√©chargement de Tailwind CSS"
    echo "   Vous pouvez le t√©l√©charger manuellement depuis: https://cdn.tailwindcss.com"
    echo "   Et le placer dans: static/js/tailwindcss.js"
}

# T√©l√©charger HTMX
echo "üì¶ T√©l√©chargement de HTMX..."
curl -L https://unpkg.com/htmx.org@1.9.10/dist/htmx.min.js -o static/js/htmx.min.js || {
    echo "‚ö†Ô∏è  √âchec du t√©l√©chargement de HTMX"
    echo "   Vous pouvez le t√©l√©charger manuellement depuis: https://unpkg.com/htmx.org@1.9.10/dist/htmx.min.js"
    echo "   Et le placer dans: static/js/htmx.min.js"
}

# T√©l√©charger Font Awesome CSS
echo "üì¶ T√©l√©chargement de Font Awesome CSS..."
curl -L https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css -o static/css/all.min.css.tmp || {
    echo "‚ö†Ô∏è  √âchec du t√©l√©chargement de Font Awesome CSS"
    echo "   Vous pouvez le t√©l√©charger manuellement depuis: https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    echo "   Et le placer dans: static/css/all.min.css"
    exit 1
}

# Corriger les chemins vers les webfonts pour qu'ils pointent vers /static/webfonts/
echo "üîß Correction des chemins dans le CSS Font Awesome..."
sed 's|url(../webfonts/|url(/static/webfonts/|g' static/css/all.min.css.tmp > static/css/all.min.css
rm static/css/all.min.css.tmp
echo "   ‚úÖ Chemins corrig√©s"

# T√©l√©charger les webfonts Font Awesome
echo "üì¶ T√©l√©chargement des webfonts Font Awesome..."
cd static/webfonts
for font in fa-brands-400.woff2 fa-regular-400.woff2 fa-solid-900.woff2; do
    echo "  - $font"
    curl -L "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/$font" -o "$font" || {
        echo "    ‚ö†Ô∏è  √âchec pour $font"
    }
done
cd ../..

# T√©l√©charger Monaco Editor
echo "üì¶ T√©l√©chargement de Monaco Editor..."
echo "‚ö†Ô∏è  Note: Monaco Editor n√©cessite de nombreux fichiers. Pour une installation compl√®te offline,"
echo "   il est recommand√© d'utiliser le CDN (d√©j√† configur√© dans l'IDE) ou de t√©l√©charger manuellement"
echo "   le package complet depuis: https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/"
echo ""
echo "   Pour l'instant, l'IDE utilise le CDN pour Monaco Editor afin d'assurer le fonctionnement."
echo "   Si vous souhaitez une version offline, vous devrez t√©l√©charger manuellement tous les fichiers"
echo "   du dossier vs/ depuis le CDN et les placer dans static/js/monaco-editor/vs/"
echo ""
# Note: On ne t√©l√©charge pas Monaco Editor ici car il n√©cessite trop de fichiers
# L'IDE utilisera le CDN par d√©faut

# T√©l√©charger Prism.js
echo "üì¶ T√©l√©chargement de Prism.js..."
cd static/js/prism || { echo "‚ùå Impossible d'acc√©der √† static/js/prism"; exit 1; }
curl -L https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js -o prism.min.js || {
    echo "‚ö†Ô∏è  √âchec du t√©l√©chargement de Prism.js"
}
curl -L https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js -o prism-markup.min.js || {
    echo "‚ö†Ô∏è  √âchec du t√©l√©chargement de Prism markup component"
}
cd ../../..
cd static/css || { echo "‚ùå Impossible d'acc√©der √† static/css"; exit 1; }
curl -L https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css -o prism-tomorrow.min.css || {
    echo "‚ö†Ô∏è  √âchec du t√©l√©chargement du th√®me Prism"
}
cd ../..

# T√©l√©charger la police Inter (Google Fonts)
echo "üì¶ T√©l√©chargement de la police Inter..."
cd static/fonts || { echo "‚ùå Impossible d'acc√©der √† static/fonts"; exit 1; }
# T√©l√©charger les fichiers WOFF2 de la police Inter
for weight in 300 400 500 600 700; do
    echo "  - Inter-$weight"
    curl -L "https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2" -o "inter-$weight.woff2" 2>/dev/null || {
        # Essayer une URL alternative
        curl -L "https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZ9hiA.woff2" -o "inter-$weight.woff2" 2>/dev/null || {
            echo "    ‚ö†Ô∏è  √âchec pour Inter-$weight"
        }
    }
done
# Cr√©er un fichier CSS local pour Inter (utiliser cat avec redirection)
{
cat << 'EOF'
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 300;
  font-display: swap;
  src: url('/static/fonts/inter-300.woff2') format('woff2');
}
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url('/static/fonts/inter-400.woff2') format('woff2');
}
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 500;
  font-display: swap;
  src: url('/static/fonts/inter-500.woff2') format('woff2');
}
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url('/static/fonts/inter-600.woff2') format('woff2');
}
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: url('/static/fonts/inter-700.woff2') format('woff2');
}
EOF
} > inter.css 2>/dev/null || {
echo "   ‚úÖ CSS Inter cr√©√©"
cd ../..

# T√©l√©charger les ic√¥nes SVG utilis√©es dans core/admin.js
echo "üì¶ T√©l√©chargement des ic√¥nes SVG..."
mkdir -p static/icons
cd static/icons

# Liste des ic√¥nes √† t√©l√©charger (format compatible zsh)
icons_data=(
    "github-icon-2.svg|https://cdn.worldvectorlogo.com/logos/github-icon-2.svg"
    "gemini-icon-logo.svg|https://cdn.worldvectorlogo.com/logos/gemini-icon-logo.svg"
    "youtube-icon-8.svg|https://cdn.worldvectorlogo.com/logos/youtube-icon-8.svg"
    "googleappsscript.svg|https://cdn.simpleicons.org/googleappsscript"
    "official-gmail-icon-2020-.svg|https://cdn.worldvectorlogo.com/logos/official-gmail-icon-2020-.svg"
    "google-drive-icon-2020.svg|https://cdn.worldvectorlogo.com/logos/google-drive-icon-2020.svg"
    "google-docs-icon-2.svg|https://cdn.worldvectorlogo.com/logos/google-docs-icon-2.svg"
    "google-sheets-logo-icon.svg|https://cdn.worldvectorlogo.com/logos/google-sheets-logo-icon.svg"
    "google-calendar-icon-2020-.svg|https://cdn.worldvectorlogo.com/logos/google-calendar-icon-2020-.svg"
    "google-meet-icon-2020-.svg|https://cdn.worldvectorlogo.com/logos/google-meet-icon-2020-.svg"
    "google-forms.svg|https://cdn.worldvectorlogo.com/logos/google-forms.svg"
    "microsoft-copilot-1.svg|https://cdn.worldvectorlogo.com/logos/microsoft-copilot-1.svg"
    "deepseek-2.svg|https://cdn.worldvectorlogo.com/logos/deepseek-2.svg"
    "wordpress-icon-1.svg|https://cdn.worldvectorlogo.com/logos/wordpress-icon-1.svg"
    "spotify-2.svg|https://cdn.worldvectorlogo.com/logos/spotify-2.svg"
    "streamyard.svg|https://static.wikia.nocookie.net/logopedia/images/c/ca/StreamYard_2021_%28Icon%29.svg"
    "facebook-2020-1-1.svg|https://cdn.worldvectorlogo.com/logos/facebook-2020-1-1.svg"
    "twitter-6.svg|https://cdn.worldvectorlogo.com/logos/twitter-6.svg"
    "instagram-2016-5.svg|https://cdn.worldvectorlogo.com/logos/instagram-2016-5.svg"
    "linkedin-icon-3.svg|https://cdn.worldvectorlogo.com/logos/linkedin-icon-3.svg"
    "tiktok-icon-2.svg|https://cdn.worldvectorlogo.com/logos/tiktok-icon-2.svg"
    "meta-3.svg|https://cdn.worldvectorlogo.com/logos/meta-3.svg"
    "stripe-4.svg|https://cdn.worldvectorlogo.com/logos/stripe-4.svg"
    "paypal-4.svg|https://cdn.worldvectorlogo.com/logos/paypal-4.svg"
    "shopify.svg|https://cdn.worldvectorlogo.com/logos/shopify.svg"
    "google-ads-2.svg|https://cdn.worldvectorlogo.com/logos/google-ads-2.svg"
    "supabase-icon.svg|https://www.vectorlogo.zone/logos/supabase/supabase-icon.svg"
    "gitlab.svg|https://cdn.worldvectorlogo.com/logos/gitlab.svg"
    "google-analytics-4.svg|https://cdn.worldvectorlogo.com/logos/google-analytics-4.svg"
    "airtable.svg|https://companieslogo.com/img/orig/airtable-5e5cc25f.svg"
    "trello.svg|https://cdn.worldvectorlogo.com/logos/trello.svg"
    "canva-wordmark-2.svg|https://cdn.worldvectorlogo.com/logos/canva-wordmark-2.svg"
    "slack-new-logo.svg|https://cdn.worldvectorlogo.com/logos/slack-new-logo.svg"
)

downloaded=0
failed=0
total=${#icons_data[@]}

for icon_entry in "${icons_data[@]}"; do
    filename="${icon_entry%%|*}"
    url="${icon_entry#*|}"
    # V√©rifier si le fichier existe d√©j√†
    if [ -f "$filename" ]; then
        echo "  ‚úì $filename (d√©j√† pr√©sent)"
        ((downloaded++))
        continue
    fi
    
    echo -n "  - T√©l√©chargement de $filename... "
    
    # Essayer plusieurs m√©thodes de t√©l√©chargement
    if command -v curl &> /dev/null; then
        # M√©thode 1: curl normal
        curl -L --fail --silent --max-time 10 "$url" -o "$filename" 2>/dev/null && {
            echo "‚úÖ"
            ((downloaded++))
            continue
        }
        
        # M√©thode 2: curl avec --insecure si SSL pose probl√®me
        curl -L --insecure --fail --silent --max-time 10 "$url" -o "$filename" 2>/dev/null && {
            echo "‚úÖ"
            ((downloaded++))
            continue
        }
        
        # M√©thode 3: wget si disponible
        if command -v wget &> /dev/null; then
            wget --quiet --timeout=10 -O "$filename" "$url" 2>/dev/null && {
                echo "‚úÖ"
                ((downloaded++))
                continue
            }
        fi
    fi
    
    echo "‚ùå"
    echo "    ‚ö†Ô∏è  √âchec: $url"
    ((failed++))
done

# V√©rifier quels fichiers ont √©t√© t√©l√©charg√©s
echo ""
echo "üìä V√©rification des ic√¥nes t√©l√©charg√©es..."
echo "   ‚úÖ $downloaded / $total ic√¥nes t√©l√©charg√©es"

if [ "$downloaded" -lt "$total" ]; then
    echo "   ‚ö†Ô∏è  Certaines ic√¥nes n'ont pas pu √™tre t√©l√©charg√©es automatiquement"
    echo "   üí° Vous pouvez les t√©l√©charger manuellement ou relancer le script"
fi
cd ../..

echo ""
echo "‚úÖ T√©l√©chargement termin√©!"
echo ""
echo "Les fichiers sont maintenant disponibles dans le dossier static/"
echo "Le serveur servira automatiquement ces fichiers en mode offline."
echo ""
echo "‚ö†Ô∏è  Note: Monaco Editor n√©cessite tous ses fichiers. Si vous rencontrez des erreurs,"
echo "   vous devrez peut-√™tre t√©l√©charger manuellement le dossier complet depuis:"
echo "   https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/"

